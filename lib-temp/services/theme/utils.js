import { colorToInt, intToHex, colorToHex } from '../../util/colorUtils';
import * as sRGB from '../../util/color/transformSRGB';
import * as LAB from '../../util/color/transformCIELAB';
export function parse(theme, isItem = false) {
    const { anchor, ...variant } = theme;
    const colors = Object.keys(variant);
    const parsedTheme = {};
    for (let i = 0; i < colors.length; ++i) {
        const name = colors[i];
        const value = theme[name];
        if (value == null)
            continue;
        if (isItem) {
            /* istanbul ignore else */
            if (name === 'base' || name.startsWith('lighten') || name.startsWith('darken')) {
                parsedTheme[name] = colorToHex(value);
            }
        }
        else if (typeof value === 'object') {
            parsedTheme[name] = parse(value, true);
        }
        else {
            parsedTheme[name] = genVariations(name, colorToInt(value));
        }
    }
    if (!isItem) {
        parsedTheme.anchor = anchor || parsedTheme.base || parsedTheme.primary.base;
    }
    return parsedTheme;
}
/**
 * Generate the CSS for a base color (.primary)
 */
const genBaseColor = (name, value) => {
    return `
.v-application .${name} {
  background-color: ${value} !important;
  border-color: ${value} !important;
}
.v-application .${name}--text {
  color: ${value} !important;
  caret-color: ${value} !important;
}`;
};
/**
 * Generate the CSS for a variant color (.primary.darken-2)
 */
const genVariantColor = (name, variant, value) => {
    const [type, n] = variant.split(/(\d)/, 2);
    return `
.v-application .${name}.${type}-${n} {
  background-color: ${value} !important;
  border-color: ${value} !important;
}
.v-application .${name}--text.text--${type}-${n} {
  color: ${value} !important;
  caret-color: ${value} !important;
}`;
};
const genColorVariableName = (name, variant = 'base') => `--v-${name}-${variant}`;
const genColorVariable = (name, variant = 'base') => `var(${genColorVariableName(name, variant)})`;
export function genStyles(theme, cssVar = false) {
    const { anchor, ...variant } = theme;
    const colors = Object.keys(variant);
    if (!colors.length)
        return '';
    let variablesCss = '';
    let css = '';
    const aColor = cssVar ? genColorVariable('anchor') : anchor;
    css += `.v-application a { color: ${aColor}; }`;
    cssVar && (variablesCss += `  ${genColorVariableName('anchor')}: ${anchor};\n`);
    for (let i = 0; i < colors.length; ++i) {
        const name = colors[i];
        const value = theme[name];
        css += genBaseColor(name, cssVar ? genColorVariable(name) : value.base);
        cssVar && (variablesCss += `  ${genColorVariableName(name)}: ${value.base};\n`);
        const variants = Object.keys(value);
        for (let i = 0; i < variants.length; ++i) {
            const variant = variants[i];
            const variantValue = value[variant];
            if (variant === 'base')
                continue;
            css += genVariantColor(name, variant, cssVar ? genColorVariable(name, variant) : variantValue);
            cssVar && (variablesCss += `  ${genColorVariableName(name, variant)}: ${variantValue};\n`);
        }
    }
    if (cssVar) {
        variablesCss = `:root {\n${variablesCss}}\n\n`;
    }
    return variablesCss + css;
}
export function genVariations(name, value) {
    const values = {
        base: intToHex(value),
    };
    for (let i = 5; i > 0; --i) {
        values[`lighten${i}`] = intToHex(lighten(value, i));
    }
    for (let i = 1; i <= 4; ++i) {
        values[`darken${i}`] = intToHex(darken(value, i));
    }
    return values;
}
export function lighten(value, amount) {
    const lab = LAB.fromXYZ(sRGB.toXYZ(value));
    lab[0] = lab[0] + amount * 10;
    return sRGB.fromXYZ(LAB.toXYZ(lab));
}
export function darken(value, amount) {
    const lab = LAB.fromXYZ(sRGB.toXYZ(value));
    lab[0] = lab[0] - amount * 10;
    return sRGB.fromXYZ(LAB.toXYZ(lab));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvc2VydmljZXMvdGhlbWUvdXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsVUFBVSxFQUFZLE1BQU0sdUJBQXVCLENBQUE7QUFDbEYsT0FBTyxLQUFLLElBQUksTUFBTSxnQ0FBZ0MsQ0FBQTtBQUN0RCxPQUFPLEtBQUssR0FBRyxNQUFNLGtDQUFrQyxDQUFBO0FBTXZELE1BQU0sVUFBVSxLQUFLLENBQ25CLEtBQXVDLEVBQ3ZDLE1BQU0sR0FBRyxLQUFLO0lBRWQsTUFBTSxFQUFFLE1BQU0sRUFBRSxHQUFHLE9BQU8sRUFBRSxHQUFHLEtBQUssQ0FBQTtJQUNwQyxNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFBO0lBQ25DLE1BQU0sV0FBVyxHQUFRLEVBQUUsQ0FBQTtJQUUzQixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsTUFBTSxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsRUFBRTtRQUN0QyxNQUFNLElBQUksR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUE7UUFDdEIsTUFBTSxLQUFLLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFBO1FBRXpCLElBQUksS0FBSyxJQUFJLElBQUk7WUFBRSxTQUFRO1FBRTNCLElBQUksTUFBTSxFQUFFO1lBQ1YsMEJBQTBCO1lBQzFCLElBQUksSUFBSSxLQUFLLE1BQU0sSUFBSSxJQUFJLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLEVBQUU7Z0JBQzlFLFdBQVcsQ0FBQyxJQUFJLENBQUMsR0FBRyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUE7YUFDdEM7U0FDRjthQUFNLElBQUksT0FBTyxLQUFLLEtBQUssUUFBUSxFQUFF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QUFDLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFBO0tBQ3BEO0lBRUQsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsRUFBRTtRQUMzQixNQUFNLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUE7S0FDbEQ7SUFFRCxPQUFPLE1BQU0sQ0FBQTtBQUNmLENBQUM7QUFFRCxNQUFNLFVBQVUsT0FBTyxDQUFFLEtBQWUsRUFBRSxNQUFjO0lBQ3RELE1BQU0sR0FBRyxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFBO0lBQzFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsTUFBTSxHQUFHLEVBQUUsQ0FBQTtJQUM3QixPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFBO0FBQ3JDLENBQUM7QUFFRCxNQUFNLFVBQVUsTUFBTSxDQUFFLEtBQWUsRUFBRSxNQUFjO0lBQ3JELE1BQU0sR0FBRyxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFBO0lBQzFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsTUFBTSxHQUFHLEVBQUUsQ0FBQTtJQUM3QixPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFBO0FBQ3JDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBjb2xvclRvSW50LCBpbnRUb0hleCwgY29sb3JUb0hleCwgQ29sb3JJbnQgfSBmcm9tICcuLi8uLi91dGlsL2NvbG9yVXRpbHMnXG5pbXBvcnQgKiBhcyBzUkdCIGZyb20gJy4uLy4uL3V0aWwvY29sb3IvdHJhbnNmb3JtU1JHQidcbmltcG9ydCAqIGFzIExBQiBmcm9tICcuLi8uLi91dGlsL2NvbG9yL3RyYW5zZm9ybUNJRUxBQidcbmltcG9ydCB7XG4gIFZ1ZXRpZnlQYXJzZWRUaGVtZSxcbiAgVnVldGlmeVRoZW1lSXRlbSxcbn0gZnJvbSAndnVldGlmeS90eXBlcy9zZXJ2aWNlcy90aGVtZSdcblxuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlIChcbiAgdGhlbWU6IFJlY29yZDxzdHJpbmcsIFZ1ZXRpZnlUaGVtZUl0ZW0+LFxuICBpc0l0ZW0gPSBmYWxzZVxuKTogVnVldGlmeVBhcnNlZFRoZW1lIHtcbiAgY29uc3QgeyBhbmNob3IsIC4uLnZhcmlhbnQgfSA9IHRoZW1lXG4gIGNvbnN0IGNvbG9ycyA9IE9iamVjdC5rZXlzKHZhcmlhbnQpXG4gIGNvbnN0IHBhcnNlZFRoZW1lOiBhbnkgPSB7fVxuXG4gIGZvciAobGV0IGkgPSAwOyBpIDwgY29sb3JzLmxlbmd0aDsgKytpKSB7XG4gICAgY29uc3QgbmFtZSA9IGNvbG9yc1tpXVxuICAgIGNvbnN0IHZhbHVlID0gdGhlbWVbbmFtZV1cblxuICAgIGlmICh2YWx1ZSA9PSBudWxsKSBjb250aW51ZVxuXG4gICAgaWYgKGlzSXRlbSkge1xuICAgICAgLyogaXN0YW5idWwgaWdub3JlIGVsc2UgKi9cbiAgICAgIGlmIChuYW1lID09PSAnYmFzZScgfHwgbmFtZS5zdGFydHNXaXRoKCdsaWdodGVuJykgfHwgbmFtZS5zdGFydHNXaXRoKCdkYXJrZW4nKSkge1xuICAgICAgICBwYXJzZWRUaGVtZVtuYW1lXSA9IGNvbG9yVG9IZXgodmFsdWUpXG4gICAgICB9XG4gICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnKSB7XG4gICAgICBwYXJzZWRUaGVtZVtuYW1lXSA9IHBhcnNlKHZhbHVlLCB0cnVlKVxuICAgIH0gZWxzZSB7XG4gICAgICBwYXJzZWRUaGVtZVtuYW1lXSA9IGdlblZhcmlhdGlvbnMobmFtZSwgY29sb3JUb0ludCh2YWx1ZSkpXG4gICAgfVxuICB9XG5cbiAgaWYgKCFpc0l0ZW0pIHtcbiAgICBwYXJzZWRUaGVtZS5hbmNob3IgPSBhbmNob3IgfHwgcGFyc2VkVGhlbWUuYmFzZSB8fCBwYXJzZWRUaGVtZS5wcmltYXJ5LmJhc2VcbiAgfVxuXG4gIHJldHVybiBwYXJzZWRUaGVtZVxufVxuXG4vKipcbiAqIEdlbmVyYXRlIHRoZSBDU1MgZm9yIGEgYmFzZSBjb2xvciAoLnByaW1hcnkpXG4gKi9cbmNvbnN0IGdlbkJhc2VDb2xvciA9IChuYW1lOiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcpOiBzdHJpbmcgPT4ge1xuICByZXR1cm4gYFxuLnYtYXBwbGljYXRpb24gLiR7bmFtZX0ge1xuICBiYWNrZ3JvdW5kLWNvbG9yOiAke3ZhbHVlfSAhaW1wb3J0YW50O1xuICBib3JkZXItY29sb3I6ICR7dmFsdWV9ICFpbXBvcnRhbnQ7XG59XG4udi1hcHBsaWNhdGlvbiAuJHtuYW1lfS0tdGV4dCB7XG4gIGNvbG9yOiAke3ZhbHVlfSAhaW1wb3J0YW50O1xuICBjYXJldC1jb2xvcjogJHt2YWx1ZX0gIWltcG9ydGFudDtcbn1gXG59XG5cbi8qKlxuICogR2VuZXJhdGUgdGhlIENTUyBmb3IgYSB2YXJpYW50IGNvbG9yICgucHJpbWFyeS5kYXJrZW4tMilcbiAqL1xuY29uc3QgZ2VuVmFyaWFudENvbG9yID0gKG5hbWU6IHN0cmluZywgdmFyaWFudDogc3RyaW5nLCB2YWx1ZTogc3RyaW5nKTogc3RyaW5nID0+IHtcbiAgY29uc3QgW3R5cGUsIG5dID0gdmFyaWFudC5zcGxpdCgvKFxcZCkvLCAyKVxuICByZXR1cm4gYFxuLnYtYXBwbGljYXRpb24gLiR7bmFtZX0uJHt0eXBlfS0ke259IHtcbiAgYmFja2dyb3VuZC1jb2xvcjogJHt2YWx1ZX0gIWltcG9ydGFudDtcbiAgYm9yZGVyLWNvbG9yOiAke3ZhbHVlfSAhaW1wb3J0YW50O1xufVxuLnYtYXBwbGljYXRpb24gLiR7bmFtZX0tLXRleHQudGV4dC0tJHt0eXBlfS0ke259IHtcbiAgY29sb3I6ICR7dmFsdWV9ICFpbXBvcnRhbnQ7XG4gIGNhcmV0LWNvbG9yOiAke3ZhbHVlfSAhaW1wb3J0YW50O1xufWBcbn1cblxuY29uc3QgZ2VuQ29sb3JWYXJpYWJsZU5hbWUgPSAobmFtZTogc3RyaW5nLCB2YXJpYW50ID0gJ2Jhc2UnKTogc3RyaW5nID0+IGAtLXYtJHtuYW1lfS0ke3ZhcmlhbnR9YFxuXG5jb25zdCBnZW5Db2xvclZhcmlhYmxlID0gKG5hbWU6IHN0cmluZywgdmFyaWFudCA9ICdiYXNlJyk6IHN0cmluZyA9PiBgdmFyKCR7Z2VuQ29sb3JWYXJpYWJsZU5hbWUobmFtZSwgdmFyaWFudCl9KWBcblxuZXhwb3J0IGZ1bmN0aW9uIGdlblN0eWxlcyAodGhlbWU6IFZ1ZXRpZnlQYXJzZWRUaGVtZSwgY3NzVmFyID0gZmFsc2UpOiBzdHJpbmcge1xuICBjb25zdCB7IGFuY2hvciwgLi4udmFyaWFudCB9ID0gdGhlbWVcbiAgY29uc3QgY29sb3JzID0gT2JqZWN0LmtleXModmFyaWFudClcblxuICBpZiAoIWNvbG9ycy5sZW5ndGgpIHJldHVybiAnJ1xuXG4gIGxldCB2YXJpYWJsZXNDc3MgPSAnJ1xuICBsZXQgY3NzID0gJydcblxuICBjb25zdCBhQ29sb3IgPSBjc3NWYXIgPyBnZW5Db2xvclZhcmlhYmxlKCdhbmNob3InKSA6IGFuY2hvclxuICBjc3MgKz0gYC52LWFwcGxpY2F0aW9uIGEgeyBjb2xvcjogJHthQ29sb3J9OyB9YFxuICBjc3NWYXIgJiYgKHZhcmlhYmxlc0NzcyArPSBgICAke2dlbkNvbG9yVmFyaWFibGVOYW1lKCdhbmNob3InKX06ICR7YW5jaG9yfTtcXG5gKVxuXG4gIGZvciAobGV0IGkgPSAwOyBpIDwgY29sb3JzLmxlbmd0aDsgKytpKSB7XG4gICAgY29uc3QgbmFtZSA9IGNvbG9yc1tpXVxuICAgIGNvbnN0IHZhbHVlID0gdGhlbWVbbmFtZV1cblxuICAgIGNzcyArPSBnZW5CYXNlQ29sb3IobmFtZSwgY3NzVmFyID8gZ2VuQ29sb3JWYXJpYWJsZShuYW1lKSA6IHZhbHVlLmJhc2UpXG4gICAgY3NzVmFyICYmICh2YXJpYWJsZXNDc3MgKz0gYCAgJHtnZW5Db2xvclZhcmlhYmxlTmFtZShuYW1lKX06ICR7dmFsdWUuYmFzZX07XFxuYClcblxuICAgIGNvbnN0IHZhcmlhbnRzID0gT2JqZWN0LmtleXModmFsdWUpXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB2YXJpYW50cy5sZW5ndGg7ICsraSkge1xuICAgICAgY29uc3QgdmFyaWFudCA9IHZhcmlhbnRzW2ldXG4gICAgICBjb25zdCB2YXJpYW50VmFsdWUgPSB2YWx1ZVt2YXJpYW50XVxuICAgICAgaWYgKHZhcmlhbnQgPT09ICdiYXNlJykgY29udGludWVcblxuICAgICAgY3NzICs9IGdlblZhcmlhbnRDb2xvcihuYW1lLCB2YXJpYW50LCBjc3NWYXIgPyBnZW5Db2xvclZhcmlhYmxlKG5hbWUsIHZhcmlhbnQpIDogdmFyaWFudFZhbHVlKVxuICAgICAgY3NzVmFyICYmICh2YXJpYWJsZXNDc3MgKz0gYCAgJHtnZW5Db2xvclZhcmlhYmxlTmFtZShuYW1lLCB2YXJpYW50KX06ICR7dmFyaWFudFZhbHVlfTtcXG5gKVxuICAgIH1cbiAgfVxuXG4gIGlmIChjc3NWYXIpIHtcbiAgICB2YXJpYWJsZXNDc3MgPSBgOnJvb3Qge1xcbiR7dmFyaWFibGVzQ3NzfX1cXG5cXG5gXG4gIH1cblxuICByZXR1cm4gdmFyaWFibGVzQ3NzICsgY3NzXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZW5WYXJpYXRpb25zIChuYW1lOiBzdHJpbmcsIHZhbHVlOiBDb2xvckludCk6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4ge1xuICBjb25zdCB2YWx1ZXM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7XG4gICAgYmFzZTogaW50VG9IZXgodmFsdWUpLFxuICB9XG5cbiAgZm9yIChsZXQgaSA9IDU7IGkgPiAwOyAtLWkpIHtcbiAgICB2YWx1ZXNbYGxpZ2h0ZW4ke2l9YF0gPSBpbnRUb0hleChsaWdodGVuKHZhbHVlLCBpKSlcbiAgfVxuXG4gIGZvciAobGV0IGkgPSAxOyBpIDw9IDQ7ICsraSkge1xuICAgIHZhbHVlc1tgZGFya2VuJHtpfWBdID0gaW50VG9IZXgoZGFya2VuKHZhbHVlLCBpKSlcbiAgfVxuXG4gIHJldHVybiB2YWx1ZXNcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGxpZ2h0ZW4gKHZhbHVlOiBDb2xvckludCwgYW1vdW50OiBudW1iZXIpOiBDb2xvckludCB7XG4gIGNvbnN0IGxhYiA9IExBQi5mcm9tWFlaKHNSR0IudG9YWVoodmFsdWUpKVxuICBsYWJbMF0gPSBsYWJbMF0gKyBhbW91bnQgKiAxMFxuICByZXR1cm4gc1JHQi5mcm9tWFlaKExBQi50b1hZWihsYWIpKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZGFya2VuICh2YWx1ZTogQ29sb3JJbnQsIGFtb3VudDogbnVtYmVyKTogQ29sb3JJbnQge1xuICBjb25zdCBsYWIgPSBMQUIuZnJvbVhZWihzUkdCLnRvWFlaKHZhbHVlKSlcbiAgbGFiWzBdID0gbGFiWzBdIC0gYW1vdW50ICogMTBcbiAgcmV0dXJuIHNSR0IuZnJvbVhZWihMQUIudG9YWVoobGFiKSlcbn1cbiJdfQ==