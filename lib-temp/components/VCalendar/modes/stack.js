import { getOverlapGroupHandler, getVisuals, hasOverlap, getNormalizedRange } from './common';
import { getTimestampIdentifier } from '../util/timestamp';
const FULL_WIDTH = 100;
const DEFAULT_OFFSET = 5;
const WIDTH_MULTIPLIER = 1.7;
/**
 * Variation of column mode where events can be stacked. The priority of this
 * mode is to stack events together taking up the least amount of space while
 * trying to ensure the content of the event is always visible as well as its
 * start and end. A sibling column has intersecting event content and must be
 * placed beside each other. Non-sibling columns are offset by 5% from the
 * previous column. The width is scaled by 1.7 so the events overlap and
 * whitespace is reduced. If there is a hole in columns the event width is
 * scaled up so it intersects with the next column. The columns have equal
 * width in the space they are given. If the event doesn't have any to the
 * right of it that intersect with it's content it's right side is extended
 * to the right side.
 */
export const stack = (events, firstWeekday, overlapThreshold) => {
    const handler = getOverlapGroupHandler(firstWeekday);
    // eslint-disable-next-line max-statements
    return (day, dayEvents, timed) => {
        if (!timed) {
            return handler.getVisuals(day, dayEvents, timed);
        }
        const dayStart = getTimestampIdentifier(day);
        const visuals = getVisuals(dayEvents, dayStart);
        const groups = getGroups(visuals, dayStart);
        for (const group of groups) {
            const nodes = [];
            for (const visual of group.visuals) {
                const child = getNode(visual, dayStart);
                const index = getNextIndex(child, nodes);
                if (index === false) {
                    const parent = getParent(child, nodes);
                    if (parent) {
                        child.parent = parent;
                        child.sibling = hasOverlap(child.start, child.end, parent.start, addTime(parent.start, overlapThreshold));
                        child.index = parent.index + 1;
                        parent.children.push(child);
                    }
                }
                else {
                    const [parent] = getOverlappingRange(child, nodes, index - 1, index - 1);
                    const children = getOverlappingRange(child, nodes, index + 1, index + nodes.length, true);
                    child.children = children;
                    child.index = index;
                    if (parent) {
                        child.parent = parent;
                        child.sibling = hasOverlap(child.start, child.end, parent.start, addTime(parent.start, overlapThreshold));
                        parent.children.push(child);
                    }
                    for (const grand of children) {
                        if (grand.parent === parent) {
                            grand.parent = child;
                        }
                        const grandNext = grand.index - child.index <= 1;
                        if (grandNext && child.sibling &&
                            hasOverlap(child.start, addTime(child.start, overlapThreshold), grand.start, grand.end)) {
                            grand.sibling = true;
                        }
                    }
                }
                nodes.push(child);
            }
            calculateBounds(nodes, overlapThreshold);
        }
        visuals.sort((a, b) => (a.left - b.left) || (a.event.startTimestampIdentifier - b.event.startTimestampIdentifier));
        return visuals;
    };
};
function calculateBounds(nodes, overlapThreshold) {
    for (const node of nodes) {
        const { visual, parent } = node;
        const columns = getMaxChildIndex(node) + 1;
        const spaceLeft = parent ? parent.visual.left : 0;
        const spaceWidth = FULL_WIDTH - spaceLeft;
        const offset = Math.min(DEFAULT_OFFSET, FULL_WIDTH / columns);
        const columnWidthMultiplier = getColumnWidthMultiplier(node, nodes);
        const columnOffset = spaceWidth / (columns - node.index + 1);
        const columnWidth = spaceWidth / (columns - node.index + (node.sibling ? 1 : 0)) * columnWidthMultiplier;
        if (parent) {
            visual.left = node.sibling
                ? spaceLeft + columnOffset
                : spaceLeft + offset;
        }
        visual.width = hasFullWidth(node, nodes, overlapThreshold)
            ? FULL_WIDTH - visual.left
            : Math.min(FULL_WIDTH - visual.left, columnWidth * WIDTH_MULTIPLIER);
    }
}
function getColumnWidthMultiplier(node, nodes) {
    if (!node.children.length) {
        return 1;
    }
    const maxColumn = node.index + nodes.length;
    const minColumn = node.children.reduce((min, c) => Math.min(min, c.index), maxColumn);
    return minColumn - node.index;
}
function getOverlappingIndices(node, nodes) {
    const indices = [];
    for (const other of nodes) {
        if (hasOverlap(node.start, node.end, other.start, other.end)) {
            indices.push(other.index);
        }
    }
    return indices;
}
function getNextIndex(node, nodes) {
    const indices = getOverlappingIndices(node, nodes);
    indices.sort();
    for (let i = 0; i < indices.length; i++) {
        if (i < indices[i]) {
            return i;
        }
    }
    return false;
}
function getOverlappingRange(node, nodes, indexMin, indexMax, returnFirstColumn = false) {
    const overlapping = [];
    for (const other of nodes) {
        if (other.index >= indexMin && other.index <= indexMax && hasOverlap(node.start, node.end, other.start, other.end)) {
            overlapping.push(other);
        }
    }
    if (returnFirstColumn && overlapping.length > 0) {
        const first = overlapping.reduce((min, n) => Math.min(min, n.index), overlapping[0].index);
        return overlapping.filter(n => n.index === first);
    }
    return overlapping;
}
function getParent(node, nodes) {
    let parent = null;
    for (const other of nodes) {
        if (hasOverlap(node.start, node.end, other.start, other.end) && (parent === null || other.index > parent.index)) {
            parent = other;
        }
    }
    return parent;
}
function hasFullWidth(node, nodes, overlapThreshold) {
    for (const other of nodes) {
        if (other !== node &&
            other.index > node.index &&
            hasOverlap(node.start, addTime(node.start, overlapThreshold), other.start, other.end)) {
            return false;
        }
    }
    return true;
}
function getGroups(visuals, dayStart) {
    const groups = [];
    for (const visual of visuals) {
        const [start, end] = getNormalizedRange(visual.event, dayStart);
        let added = false;
        for (const group of groups) {
            if (hasOverlap(start, end, group.start, group.end)) {
                group.visuals.push(visual);
                group.end = Math.max(group.end, end);
                added = true;
                break;
            }
        }
        if (!added) {
            groups.push({ start, end, visuals: [visual] });
        }
    }
    return groups;
}
function getNode(visual, dayStart) {
    const [start, end] = getNormalizedRange(visual.event, dayStart);
    return {
        parent: null,
        sibling: true,
        index: 0,
        visual,
        start,
        end,
        children: [],
    };
}
function getMaxChildIndex(node) {
    let max = node.index;
    for (const child of node.children) {
        const childMax = getMaxChildIndex(child);
        if (childMax > max) {
            max = childMax;
        }
    }
    return max;
}
function addTime(identifier, minutes) {
    const removeMinutes = identifier % 100;
    const totalMinutes = removeMinutes + minutes;
    const addHours = Math.floor(totalMinutes / 60);
    const addMinutes = totalMinutes % 60;
    return identifier - removeMinutes + addHours * 100 + addMinutes;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhY2suanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY29tcG9uZW50cy9WQ2FsZW5kYXIvbW9kZXMvc3RhY2sudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLHNCQUFzQixFQUFFLFVBQVUsRUFBRSxVQUFVLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxVQUFVLENBQUE7QUFDN0YsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sbUJBQW1CLENBQUE7QUFrQjFELE1BQU0sVUFBVSxHQUFHLEdBQUcsQ0FBQTtBQUV0QixNQUFNLGNBQWMsR0FBRyxDQUFDLENBQUE7QUFFeEIsTUFBTSxnQkFBZ0IsR0FBRyxHQUFHLENBQUE7QUFFNUI7Ozs7Ozs7Ozs7OztHQVlHO0FBRUgsTUFBTSxDQUFDLE1BQU0sS0FBSyxHQUE2QixDQUFDLE1BQU0sRUFBRSxZQUFZLEVBQUUsZ0JBQWdCLEVBQUUsRUFBRTtJQUN4RixNQUFNLE9BQU8sR0FBRyxzQkFBc0IsQ0FBQyxZQUFZLENBQUMsQ0FBQTtJQUVwRCwwQ0FBMEM7SUFDMUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLEVBQUU7UUFDL0IsSUFBSSxDQUFDLEtBQUssRUFBRTtZQUNWLE9BQU8sT0FBTyxDQUFDLFVBQVUsQ0FBQyxHQUFHLEVBQUUsU0FBUyxFQUFFLEtBQUssQ0FBQyxDQUFBO1NBQ2pEO1FBRUQsTUFBTSxRQUFRLEdBQUcsc0JBQXNCLENBQUMsR0FBRyxDQUFDLENBQUE7UUFDNUMsTUFBTSxPQUFPLEdBQUcsVUFBVSxDQUFDLFNBQVMsRUFBRSxRQUFRLENBQUMsQ0FBQTtRQUMvQyxNQUFNLE1BQU0sR0FBRyxTQUFTLENBQUMsT0FBTyxFQUFFLFFBQVEsQ0FBQyxDQUFBO1FBRTNDLEtBQUssTUFBTSxLQUFLLElBQUksTUFBTSxFQUFFO1lBQzFCLE1BQU0sS0FBSyxHQUFXLEVBQUUsQ0FBQTtZQUV4QixLQUFLLE1BQU0sTUFB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QUFHLElBQUksQ0FBQyxLQUFLLENBQUE7SUFDcEIsS0FBSyxNQUFNLEtBQUssSUFBSSxJQUFJLENBQUMsUUFBUSxFQUFFO1FBQ2pDLE1BQU0sUUFBUSxHQUFHLGdCQUFnQixDQUFDLEtBQUssQ0FBQyxDQUFBO1FBQ3hDLElBQUksUUFBUSxHQUFHLEdBQUcsRUFBRTtZQUNsQixHQUFHLEdBQUcsUUFBUSxDQUFBO1NBQ2Y7S0FDRjtJQUNELE9BQU8sR0FBRyxDQUFBO0FBQ1osQ0FBQztBQUVELFNBQVMsT0FBTyxDQUFFLFVBQWtCLEVBQUUsT0FBZTtJQUNuRCxNQUFNLGFBQWEsR0FBRyxVQUFVLEdBQUcsR0FBRyxDQUFBO0lBQ3RDLE1BQU0sWUFBWSxHQUFHLGFBQWEsR0FBRyxPQUFPLENBQUE7SUFDNUMsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxZQUFZLEdBQUcsRUFBRSxDQUFDLENBQUE7SUFDOUMsTUFBTSxVQUFVLEdBQUcsWUFBWSxHQUFHLEVBQUUsQ0FBQTtJQUVwQyxPQUFPLFVBQVUsR0FBRyxhQUFhLEdBQUcsUUFBUSxHQUFHLEdBQUcsR0FBRyxVQUFVLENBQUE7QUFDakUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENhbGVuZGFyRXZlbnRPdmVybGFwTW9kZSwgQ2FsZW5kYXJFdmVudFZpc3VhbCB9IGZyb20gJ3R5cGVzJ1xuaW1wb3J0IHsgZ2V0T3ZlcmxhcEdyb3VwSGFuZGxlciwgZ2V0VmlzdWFscywgaGFzT3ZlcmxhcCwgZ2V0Tm9ybWFsaXplZFJhbmdlIH0gZnJvbSAnLi9jb21tb24nXG5pbXBvcnQgeyBnZXRUaW1lc3RhbXBJZGVudGlmaWVyIH0gZnJvbSAnLi4vdXRpbC90aW1lc3RhbXAnXG5cbmludGVyZmFjZSBHcm91cCB7XG4gIHN0YXJ0OiBudW1iZXJcbiAgZW5kOiBudW1iZXJcbiAgdmlzdWFsczogQ2FsZW5kYXJFdmVudFZpc3VhbFtdXG59XG5cbmludGVyZmFjZSBOb2RlIHtcbiAgcGFyZW50OiBOb2RlIHwgbnVsbFxuICBzaWJsaW5nOiBib29sZWFuXG4gIGluZGV4OiBudW1iZXJcbiAgdmlzdWFsOiBDYWxlbmRhckV2ZW50VmlzdWFsXG4gIHN0YXJ0OiBudW1iZXJcbiAgZW5kOiBudW1iZXJcbiAgY2hpbGRyZW46IE5vZGVbXVxufVxuXG5jb25zdCBGVUxMX1dJRFRIID0gMTAwXG5cbmNvbnN0IERFRkFVTFRfT0ZGU0VUID0gNVxuXG5jb25zdCBXSURUSF9NVUxUSVBMSUVSID0gMS43XG5cbi8qKlxuICogVmFyaWF0aW9uIG9mIGNvbHVtbiBtb2RlIHdoZXJlIGV2ZW50cyBjYW4gYmUgc3RhY2tlZC4gVGhlIHByaW9yaXR5IG9mIHRoaXNcbiAqIG1vZGUgaXMgdG8gc3RhY2sgZXZlbnRzIHRvZ2V0aGVyIHRha2luZyB1cCB0aGUgbGVhc3QgYW1vdW50IG9mIHNwYWNlIHdoaWxlXG4gKiB0cnlpbmcgdG8gZW5zdXJlIHRoZSBjb250ZW50IG9mIHRoZSBldmVudCBpcyBhbHdheXMgdmlzaWJsZSBhcyB3ZWxsIGFzIGl0c1xuICogc3RhcnQgYW5kIGVuZC4gQSBzaWJsaW5nIGNvbHVtbiBoYXMgaW50ZXJzZWN0aW5nIGV2ZW50IGNvbnRlbnQgYW5kIG11c3QgYmVcbiAqIHBsYWNlZCBiZXNpZGUgZWFjaCBvdGhlci4gTm9uLXNpYmxpbmcgY29sdW1ucyBhcmUgb2Zmc2V0IGJ5IDUlIGZyb20gdGhlXG4gKiBwcmV2aW91cyBjb2x1bW4uIFRoZSB3aWR0aCBpcyBzY2FsZWQgYnkgMS43IHNvIHRoZSBldmVudHMgb3ZlcmxhcCBhbmRcbiAqIHdoaXRlc3BhY2UgaXMgcmVkdWNlZC4gSWYgdGhlcmUgaXMgYSBob2xlIGluIGNvbHVtbnMgdGhlIGV2ZW50IHdpZHRoIGlzXG4gKiBzY2FsZWQgdXAgc28gaXQgaW50ZXJzZWN0cyB3aXRoIHRoZSBuZXh0IGNvbHVtbi4gVGhlIGNvbHVtbnMgaGF2ZSBlcXVhbFxuICogd2lkdGggaW4gdGhlIHNwYWNlIHRoZXkgYXJlIGdpdmVuLiBJZiB0aGUgZXZlbnQgZG9lc24ndCBoYXZlIGFueSB0byB0aGVcbiAqIHJpZ2h0IG9mIGl0IHRoYXQgaW50ZXJzZWN0IHdpdGggaXQncyBjb250ZW50IGl0J3MgcmlnaHQgc2lkZSBpcyBleHRlbmRlZFxuICogdG8gdGhlIHJpZ2h0IHNpZGUuXG4gKi9cblxuZXhwb3J0IGNvbnN0IHN0YWNrOiBDYWxlbmRhckV2ZW50T3ZlcmxhcE1vZGUgPSAoZXZlbnRzLCBmaXJzdFdlZWtkYXksIG92ZXJsYXBUaHJlc2hvbGQpID0+IHtcbiAgY29uc3QgaGFuZGxlciA9IGdldE92ZXJsYXBHcm91cEhhbmRsZXIoZmlyc3RXZWVrZGF5KVxuXG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBtYXgtc3RhdGVtZW50c1xuICByZXR1cm4gKGRheSwgZGF5RXZlbnRzLCB0aW1lZCkgPT4ge1xuICAgIGlmICghdGltZWQpIHtcbiAgICAgIHJldHVybiBoYW5kbGVyLmdldFZpc3VhbHMoZGF5LCBkYXlFdmVudHMsIHRpbWVkKVxuICAgIH1cblxuICAgIGNvbnN0IGRheVN0YXJ0ID0gZ2V0VGltZXN0YW1wSWRlbnRpZmllcihkYXkpXG4gICAgY29uc3QgdmlzdWFscyA9IGdldFZpc3VhbHMoZGF5RXZlbnRzLCBkYXlTdGFydClcbiAgICBjb25zdCBncm91cHMgPSBnZXRHcm91cHModmlzdWFscywgZGF5U3RhcnQpXG5cbiAgICBmb3IgKGNvbnN0IGdyb3VwIG9mIGdyb3Vwcykge1xuICAgICAgY29uc3Qgbm9kZXM6IE5vZGVbXSA9IFtdXG5cbiAgICAgIGZvciAoY29uc3QgdmlzdWFsIG9mIGdyb3VwLnZpc3VhbHMpIHtcbiAgICAgICAgY29uc3QgY2hpbGQgPSBnZXROb2RlKHZpc3VhbCwgZGF5U3RhcnQpXG4gICAgICAgIGNvbnN0IGluZGV4ID0gZ2V0TmV4dEluZGV4KGNoaWxkLCBub2RlcylcblxuICAgICAgICBpZiAoaW5kZXggPT09IGZhbHNlKSB7XG4gICAgICAgICAgY29uc3QgcGFyZW50ID0gZ2V0UGFyZW50KGNoaWxkLCBub2RlcylcbiAgICAgICAgICBpZiAocGFyZW50KSB7XG4gICAgICAgICAgICBjaGlsZC5wYXJlbnQgPSBwYXJlbnRcbiAgICAgICAgICAgIGNoaWxkLnNpYmxpbmcgPSBoYXNPdmVybGFwKGNoaWxkLnN0YXJ0LCBjaGlsZC5lbmQsIHBhcmVudC5zdGFydCwgYWRkVGltZShwYXJlbnQuc3RhcnQsIG92ZXJsYXBUaHJlc2hvbGQpKVxuICAgICAgICAgICAgY2hpbGQuaW5kZXggPSBwYXJlbnQuaW5kZXggKyAxXG4gICAgICAgICAgICBwYXJlbnQuY2hpbGRyZW4ucHVzaChjaGlsZClcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc3QgW3BhcmVudF0gPSBnZXRPdmVybGFwcGluZ1JhbmdlKGNoaWxkLCBub2RlcywgaW5kZXggLSAxLCBpbmRleCAtIDEpXG4gICAgICAgICAgY29uc3QgY2hpbGRyZW4gPSBnZXRPdmVybGFwcGluZ1JhbmdlKGNoaWxkLCBub2RlcywgaW5kZXggKyAxLCBpbmRleCArIG5vZGVzLmxlbmd0aCwgdHJ1ZSlcblxuICAgICAgICAgIGNoaWxkLmNoaWxkcmVuID0gY2hpbGRyZW5cbiAgICAgICAgICBjaGlsZC5pbmRleCA9IGluZGV4XG5cbiAgICAgICAgICBpZiAocGFyZW50KSB7XG4gICAgICAgICAgICBjaGlsZC5wYXJlbnQgPSBwYXJlbnRcbiAgICAgICAgICAgIGNoaWxkLnNpYmxpbmcgPSBoYXNPdmVybGFwKGNoaWxkLnN0YXJ0LCBjaGlsZC5lbmQsIHBhcmVudC5zdGFydCwgYWRkVGltZShwYXJlbnQuc3RhcnQsIG92ZXJsYXBUaHJlc2hvbGQpKVxuICAgICAgICAgICAgcGFyZW50LmNoaWxkcmVuLnB1c2goY2hpbGQpXG4gICAgICAgICAgfVxuXG4gICAgICAgICAgZm9yIChjb25zdCBncmFuZCBvZiBjaGlsZHJlbikge1xuICAgICAgICAgICAgaWYgKGdyYW5kLnBhcmVudCA9PT0gcGFyZW50KSB7XG4gICAgICAgICAgICAgIGdyYW5kLnBhcmVudCA9IGNoaWxkXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IGdyYW5kTmV4dCA9IGdyYW5kLmluZGV4IC0gY2hpbGQuaW5kZXggPD0gMVxuICAgICAgICAgICAgaWYgKGdyYW5kTmV4dCAmJiBjaGlsZC5zaWJsaW5nICYmXG4gICAgICAgICAgICAgIGhhc092ZXJsYXAoY2hpbGQuc3RhcnQsIGFkZFRpbWUoY2hpbGQuc3RhcnQsIG92ZXJsYXBUaHJlc2hvbGQpLCBncmFuZC5zdGFydCwgZ3JhbmQuZW5kKSkge1xuICAgICAgICAgICAgICBncmFuZC5zaWJsaW5nID0gdHJ1ZVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIG5vZGVzLnB1c2goY2hpbGQpXG4gICAgICB9XG5cbiAgICAgIGNhbGN1bGF0ZUJvdW5kcyhub2Rlcywgb3ZlcmxhcFRocmVzaG9sZClcbiAgICB9XG5cbiAgICB2aXN1YWxzLnNvcnQoKGEsIGIpID0+IChhLmxlZnQgLSBiLmxlZnQpIHx8IChhLmV2ZW50LnN0YXJ0VGltZXN0YW1wSWRlbnRpZmllciAtIGIuZXZlbnQuc3RhcnRUaW1lc3RhbXBJZGVudGlmaWVyKSlcblxuICAgIHJldHVybiB2aXN1YWxzXG4gIH1cbn1cblxuZnVuY3Rpb24gY2FsY3VsYXRlQm91bmRzIChub2RlczogTm9kZVtdLCBvdmVybGFwVGhyZXNob2xkOiBudW1iZXIpIHtcbiAgZm9yIChjb25zdCBub2RlIG9mIG5vZGVzKSB7XG4gICAgY29uc3QgeyB2aXN1YWwsIHBhcmVudCB9ID0gbm9kZVxuICAgIGNvbnN0IGNvbHVtbnMgPSBnZXRNYXhDaGlsZEluZGV4KG5vZGUpICsgMVxuICAgIGNvbnN0IHNwYWNlTGVmdCA9IHBhcmVudCA/IHBhcmVudC52aXN1YWwubGVmdCA6IDBcbiAgICBjb25zdCBzcGFjZVdpZHRoID0gRlVMTF9XSURUSCAtIHNwYWNlTGVmdFxuICAgIGNvbnN0IG9mZnNldCA9IE1hdGgubWluKERFRkFVTFRfT0ZGU0VULCBGVUxMX1dJRFRIIC8gY29sdW1ucylcbiAgICBjb25zdCBjb2x1bW5XaWR0aE11bHRpcGxpZXIgPSBnZXRDb2x1bW5XaWR0aE11bHRpcGxpZXIobm9kZSwgbm9kZXMpXG4gICAgY29uc3QgY29sdW1uT2Zmc2V0ID0gc3BhY2VXaWR0aCAvIChjb2x1bW5zIC0gbm9kZS5pbmRleCArIDEpXG4gICAgY29uc3QgY29sdW1uV2lkdGggPSBzcGFjZVdpZHRoIC8gKGNvbHVtbnMgLSBub2RlLmluZGV4ICsgKG5vZGUuc2libGluZyA/IDEgOiAwKSkgKiBjb2x1bW5XaWR0aE11bHRpcGxpZXJcblxuICAgIGlmIChwYXJlbnQpIHtcbiAgICAgIHZpc3VhbC5sZWZ0ID0gbm9kZS5zaWJsaW5nXG4gICAgICAgID8gc3BhY2VMZWZ0ICsgY29sdW1uT2Zmc2V0XG4gICAgICAgIDogc3BhY2VMZWZ0ICsgb2Zmc2V0XG4gICAgfVxuXG4gICAgdmlzdWFsLndpZHRoID0gaGFzRnVsbFdpZHRoKG5vZGUsIG5vZGVzLCBvdmVybGFwVGhyZXNob2xkKVxuICAgICAgPyBGVUxMX1dJRFRIIC0gdmlzdWFsLmxlZnRcbiAgICAgIDogTWF0aC5taW4oRlVMTF9XSURUSCAtIHZpc3VhbC5sZWZ0LCBjb2x1bW5XaWR0aCAqIFdJRFRIX01VTFRJUExJRVIpXG4gIH1cbn1cblxuZnVuY3Rpb24gZ2V0Q29sdW1uV2lkdGhNdWx0aXBsaWVyIChub2RlOiBOb2RlLCBub2RlczogTm9kZVtdKTogbnVtYmVyIHtcbiAgaWYgKCFub2RlLmNoaWxkcmVuLmxlbmd0aCkge1xuICAgIHJldHVybiAxXG4gIH1cblxuICBjb25zdCBtYXhDb2x1bW4gPSBub2RlLmluZGV4ICsgbm9kZXMubGVuZ3RoXG4gIGNvbnN0IG1pbkNvbHVtbiA9IG5vZGUuY2hpbGRyZW4ucmVkdWNlKChtaW4sIGMpID0+IE1hdGgubWluKG1pbiwgYy5pbmRleCksIG1heENvbHVtbilcblxuICByZXR1cm4gbWluQ29sdW1uIC0gbm9kZS5pbmRleFxufVxuXG5mdW5jdGlvbiBnZXRPdmVybGFwcGluZ0luZGljZXMgKG5vZGU6IE5vZGUsIG5vZGVzOiBOb2RlW10pOiBudW1iZXJbXSB7XG4gIGNvbnN0IGluZGljZXM6IG51bWJlcltdID0gW11cbiAgZm9yIChjb25zdCBvdGhlciBvZiBub2Rlcykge1xuICAgIGlmIChoYXNPdmVybGFwKG5vZGUuc3RhcnQsIG5vZGUuZW5kLCBvdGhlci5zdGFydCwgb3RoZXIuZW5kKSkge1xuICAgICAgaW5kaWNlcy5wdXNoKG90aGVyLmluZGV4KVxuICAgIH1cbiAgfVxuICByZXR1cm4gaW5kaWNlc1xufVxuXG5mdW5jdGlvbiBnZXROZXh0SW5kZXggKG5vZGU6IE5vZGUsIG5vZGVzOiBOb2RlW10pOiBudW1iZXIgfCBmYWxzZSB7XG4gIGNvbnN0IGluZGljZXMgPSBnZXRPdmVybGFwcGluZ0luZGljZXMobm9kZSwgbm9kZXMpXG4gIGluZGljZXMuc29ydCgpXG5cbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbmRpY2VzLmxlbmd0aDsgaSsrKSB7XG4gICAgaWYgKGkgPCBpbmRpY2VzW2ldKSB7XG4gICAgICByZXR1cm4gaVxuICAgIH1cbiAgfVxuICByZXR1cm4gZmFsc2Vcbn1cblxuZnVuY3Rpb24gZ2V0T3ZlcmxhcHBpbmdSYW5nZSAobm9kZTogTm9kZSwgbm9kZXM6IE5vZGVbXSwgaW5kZXhNaW46IG51bWJlciwgaW5kZXhNYXg6IG51bWJlciwgcmV0dXJuRmlyc3RDb2x1bW4gPSBmYWxzZSk6IE5vZGVbXSB7XG4gIGNvbnN0IG92ZXJsYXBwaW5nOiBOb2RlW10gPSBbXVxuICBmb3IgKGNvbnN0IG90aGVyIG9mIG5vZGVzKSB7XG4gICAgaWYgKG90aGVyLmluZGV4ID49IGluZGV4TWluICYmIG90aGVyLmluZGV4IDw9IGluZGV4TWF4ICYmIGhhc092ZXJsYXAobm9kZS5zdGFydCwgbm9kZS5lbmQsIG90aGVyLnN0YXJ0LCBvdGhlci5lbmQpKSB7XG4gICAgICBvdmVybGFwcGluZy5wdXNoKG90aGVyKVxuICAgIH1cbiAgfVxuICBpZiAocmV0dXJuRmlyc3RDb2x1bW4gJiYgb3ZlcmxhcHBpbmcubGVuZ3RoID4gMCkge1xuICAgIGNvbnN0IGZpcnN0ID0gb3ZlcmxhcHBpbmcucmVkdWNlKChtaW4sIG4pID0+IE1hdGgubWluKG1pbiwgbi5pbmRleCksIG92ZXJsYXBwaW5nWzBdLmluZGV4KVxuICAgIHJldHVybiBvdmVybGFwcGluZy5maWx0ZXIobiA9PiBuLmluZGV4ID09PSBmaXJzdClcbiAgfVxuICByZXR1cm4gb3ZlcmxhcHBpbmdcbn1cblxuZnVuY3Rpb24gZ2V0UGFyZW50IChub2RlOiBOb2RlLCBub2RlczogTm9kZVtdKTogTm9kZSB8IG51bGwge1xuICBsZXQgcGFyZW50OiBOb2RlIHwgbnVsbCA9IG51bGxcbiAgZm9yIChjb25zdCBvdGhlciBvZiBub2Rlcykge1xuICAgIGlmIChoYXNPdmVybGFwKG5vZGUuc3RhcnQsIG5vZGUuZW5kLCBvdGhlci5zdGFydCwgb3RoZXIuZW5kKSAmJiAocGFyZW50ID09PSBudWxsIHx8IG90aGVyLmluZGV4ID4gcGFyZW50LmluZGV4KSkge1xuICAgICAgcGFyZW50ID0gb3RoZXJcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHBhcmVudFxufVxuXG5mdW5jdGlvbiBoYXNGdWxsV2lkdGggKG5vZGU6IE5vZGUsIG5vZGVzOiBOb2RlW10sIG92ZXJsYXBUaHJlc2hvbGQ6IG51bWJlcik6IGJvb2xlYW4ge1xuICBmb3IgKGNvbnN0IG90aGVyIG9mIG5vZGVzKSB7XG4gICAgaWYgKG90aGVyICE9PSBub2RlICYmXG4gICAgICBvdGhlci5pbmRleCA+IG5vZGUuaW5kZXggJiZcbiAgICAgIGhhc092ZXJsYXAobm9kZS5zdGFydCwgYWRkVGltZShub2RlLnN0YXJ0LCBvdmVybGFwVGhyZXNob2xkKSwgb3RoZXIuc3RhcnQsIG90aGVyLmVuZCkpIHtcbiAgICAgIHJldHVybiBmYWxzZVxuICAgIH1cbiAgfVxuXG4gIHJldHVybiB0cnVlXG59XG5cbmZ1bmN0aW9uIGdldEdyb3VwcyAodmlzdWFsczogQ2FsZW5kYXJFdmVudFZpc3VhbFtdLCBkYXlTdGFydDogbnVtYmVyKTogR3JvdXBbXSB7XG4gIGNvbnN0IGdyb3VwczogR3JvdXBbXSA9IFtdXG5cbiAgZm9yIChjb25zdCB2aXN1YWwgb2YgdmlzdWFscykge1xuICAgIGNvbnN0IFtzdGFydCwgZW5kXSA9IGdldE5vcm1hbGl6ZWRSYW5nZSh2aXN1YWwuZXZlbnQsIGRheVN0YXJ0KVxuICAgIGxldCBhZGRlZCA9IGZhbHNlXG5cbiAgICBmb3IgKGNvbnN0IGdyb3VwIG9mIGdyb3Vwcykge1xuICAgICAgaWYgKGhhc092ZXJsYXAoc3RhcnQsIGVuZCwgZ3JvdXAuc3RhcnQsIGdyb3VwLmVuZCkpIHtcbiAgICAgICAgZ3JvdXAudmlzdWFscy5wdXNoKHZpc3VhbClcbiAgICAgICAgZ3JvdXAuZW5kID0gTWF0aC5tYXgoZ3JvdXAuZW5kLCBlbmQpXG4gICAgICAgIGFkZGVkID0gdHJ1ZVxuICAgICAgICBicmVha1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmICghYWRkZWQpIHtcbiAgICAgIGdyb3Vwcy5wdXNoKHsgc3RhcnQsIGVuZCwgdmlzdWFsczogW3Zpc3VhbF0gfSlcbiAgICB9XG4gIH1cblxuICByZXR1cm4gZ3JvdXBzXG59XG5cbmZ1bmN0aW9uIGdldE5vZGUgKHZpc3VhbDogQ2FsZW5kYXJFdmVudFZpc3VhbCwgZGF5U3RhcnQ6IG51bWJlcik6IE5vZGUge1xuICBjb25zdCBbc3RhcnQsIGVuZF0gPSBnZXROb3JtYWxpemVkUmFuZ2UodmlzdWFsLmV2ZW50LCBkYXlTdGFydClcblxuICByZXR1cm4ge1xuICAgIHBhcmVudDogbnVsbCxcbiAgICBzaWJsaW5nOiB0cnVlLFxuICAgIGluZGV4OiAwLFxuICAgIHZpc3VhbCxcbiAgICBzdGFydCxcbiAgICBlbmQsXG4gICAgY2hpbGRyZW46IFtdLFxuICB9XG59XG5cbmZ1bmN0aW9uIGdldE1heENoaWxkSW5kZXggKG5vZGU6IE5vZGUpOiBudW1iZXIge1xuICBsZXQgbWF4ID0gbm9kZS5pbmRleFxuICBmb3IgKGNvbnN0IGNoaWxkIG9mIG5vZGUuY2hpbGRyZW4pIHtcbiAgICBjb25zdCBjaGlsZE1heCA9IGdldE1heENoaWxkSW5kZXgoY2hpbGQpXG4gICAgaWYgKGNoaWxkTWF4ID4gbWF4KSB7XG4gICAgICBtYXggPSBjaGlsZE1heFxuICAgIH1cbiAgfVxuICByZXR1cm4gbWF4XG59XG5cbmZ1bmN0aW9uIGFkZFRpbWUgKGlkZW50aWZpZXI6IG51bWJlciwgbWludXRlczogbnVtYmVyKTogbnVtYmVyIHtcbiAgY29uc3QgcmVtb3ZlTWludXRlcyA9IGlkZW50aWZpZXIgJSAxMDBcbiAgY29uc3QgdG90YWxNaW51dGVzID0gcmVtb3ZlTWludXRlcyArIG1pbnV0ZXNcbiAgY29uc3QgYWRkSG91cnMgPSBNYXRoLmZsb29yKHRvdGFsTWludXRlcyAvIDYwKVxuICBjb25zdCBhZGRNaW51dGVzID0gdG90YWxNaW51dGVzICUgNjBcblxuICByZXR1cm4gaWRlbnRpZmllciAtIHJlbW92ZU1pbnV0ZXMgKyBhZGRIb3VycyAqIDEwMCArIGFkZE1pbnV0ZXNcbn1cbiJdfQ==