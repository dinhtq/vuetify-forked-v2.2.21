// Styles
import './VRipple.sass';
// Utilities
import { consoleWarn } from '../../util/console';
import { keyCodes } from '../../util/helpers';
function transform(el, value) {
    el.style['transform'] = value;
    el.style['webkitTransform'] = value;
}
function opacity(el, value) {
    el.style['opacity'] = value.toString();
}
function isTouchEvent(e) {
    return e.constructor.name === 'TouchEvent';
}
function isKeyboardEvent(e) {
    return e.constructor.name === 'KeyboardEvent';
}
const calculate = (e, el, value = {}) => {
    let localX = 0;
    let localY = 0;
    if (!isKeyboardEvent(e)) {
        const offset = el.getBoundingClientRect();
        const target = isTouchEvent(e) ? e.touches[e.touches.length - 1] : e;
        localX = target.clientX - offset.left;
        localY = target.clientY - offset.top;
    }
    let radius = 0;
    let scale = 0.3;
    if (el._ripple && el._ripple.circle) {
        scale = 0.15;
        radius = el.clientWidth / 2;
        radius = value.center ? radius : radius + Math.sqrt((localX - radius) ** 2 + (localY - radius) ** 2) / 4;
    }
    else {
        radius = Math.sqrt(el.clientWidth ** 2 + el.clientHeight ** 2) / 2;
    }
    const centerX = `${(el.clientWidth - (radius * 2)) / 2}px`;
    const centerY = `${(el.clientHeight - (radius * 2)) / 2}px`;
    const x = value.center ? centerX : `${localX - radius}px`;
    const y = value.center ? centerY : `${localY - radius}px`;
    return { radius, scale, x, y, centerX, centerY };
};
const ripples = {
    /* eslint-disable max-statements */
    show(e, el, value = {}) {
        if (!el._ripple || !el._ripple.enabled) {
            return;
        }
        const container = document.createElement('span');
        const animation = document.createElement('span');
        container.appendChild(animation);
        container.className = 'v-ripple__container';
        if (value.class) {
            container.className += ` ${value.class}`;
        }
        const { radius, scale, x, y, centerX, centerY } = calculate(e, el, value);
        const size = `${radius * 2}px`;
        animation.className = 'v-ripple__animation';
        animation.style.width = size;
        animation.style.height = size;
        el.appendChild(container);
        const computed = window.getComputedStyle(el);
        if (computed && computed.position === 'static') {
            el.style.position = 'relative';
            el.dataset.previousPosition = 'static';
        }
        animation.classList.add('v-ripple__animation--enter');
        animation.classList.add('v-ripple__animation--visible');
        transform(animation, `translate(${x}, ${y}) scale3d(${scale},${scale},${scale})`);
        opacity(animation, 0);
        animation.dataset.activated = String(performance.now());
        setTimeout(() => {
            animation.classList.remove('v-ripple__animation--enter');
            animation.classList.add('v-ripple__animation--in');
            transform(animation, `translate(${centerX}, ${centerY}) scale3d(1,1,1)`);
            opacity(animation, 0.25);
        }, 0);
    },
    hide(el) {
        if (!el || !el._ripple || !el._ripple.enabled)
            return;
        const ripples = el.getElementsByClassName('v-ripple__animation');
        if (ripples.length === 0)
            return;
        const animation = ripples[ripples.length - 1];
        if (animation.dataset.isHiding)
            return;
        else
            animation.dataset.isHiding = 'true';
        const diff = performance.now() - Number(animation.dataset.activated);
        const delay = Math.max(250 - diff, 0);
        setTimeout(() => {
            animation.classList.remove('v-ripple__animation--in');
            animation.classList.add('v-ripple__animation--out');
            opacity(animation, 0);
            setTimeout(() => {
                const ripples = el.getElementsByClassName('v-ripple__animation');
                if (ripples.length === 1 && el.dataset.previousPosition) {
                    el.style.position = el.dataset.previousPosition;
                    delete el.dataset.previousPosition;
                }
                animation.parentNode && el.removeChild(animation.parentNode);
            }, 300);
        }, delay);
    },
};
function isRippleEnabled(value) {
    return typeof value === 'undefined' || !!value;
}
function rippleShow(e) {
    const value = {};
    const element = e.currentTarget;
    if (!element || !element._ripple || element._ripple.touched)
        return;
    if (isTouchEvent(e)) {
        element._ripple.touched = true;
        element._ripple.isTouch = true;
    }
    else {
        // It's possible for touch events to fire
        // as mouse events on Android/iOS, this
        // will skip the event call if it has
        // already been registered as touch
        if (element._ripple.isTouch)
            return;
    }
    value.center = element._ripple.centered || isKeyboardEvent(e);
    if (element._ripple.class) {
        value.class = element._ripple.class;
    }
    ripples.show(e, element, value);
}
function rippleHide(e) {
    const element = e.currentTarget;
    if (!element)
        return;
    window.setTimeout(() => {
        if (element._ripple) {
            element._ripple.touched = false;
        }
    });
    ripples.hide(element);
}
let keyboardRipple = false;
function keyboardRippleShow(e) {
    if (!keyboardRipple && (e.keyCode === keyCodes.enter || e.keyCode === keyCodes.space)) {
        keyboardRipple = true;
        rippleShow(e);
    }
}
function keyboardRippleHide(e) {
    keyboardRipple = false;
    rippleHide(e);
}
function updateRipple(el, binding, wasEnabled) {
    const enabled = isRippleEnabled(binding.value);
    if (!enabled) {
        ripples.hide(el);
    }
    el._ripple = el._ripple || {};
    el._ripple.enabled = enabled;
    const value = binding.value || {};
    if (value.center) {
        el._ripple.centered = true;
    }
    if (value.class) {
        el._ripple.class = binding.value.class;
    }
    if (value.circle) {
        el._ripple.circle = value.circle;
    }
    if (enabled && !wasEnabled) {
        el.addEventListener('touchstart', rippleShow, { passive: true });
        el.addEventListener('touchend', rippleHide, { passive: true });
        el.addEventListener('touchcancel', rippleHide);
        el.addEventListener('mousedown', rippleShow);
        el.addEventListener('mouseup', rippleHide);
        el.addEventListener('mouseleave', rippleHide);
        el.addEventListener('keydown', keyboardRippleShow);
        el.addEventListener('keyup', keyboardRippleHide);
        // Anchor tags can be dragged, causes other hides to fail - #1537
        el.addEventListener('dragstart', rippleHide, { passive: true });
    }
    else if (!enabled && wasEnabled) {
        removeListeners(el);
    }
}
function removeListeners(el) {
    el.removeEventListener('mousedown', rippleShow);
    el.removeEventListener('touchstart', rippleShow);
    el.removeEventListener('touchend', rippleHide);
    el.removeEventListener('touchcancel', rippleHide);
    el.removeEventListener('mouseup', rippleHide);
    el.removeEventListener('mouseleave', rippleHide);
    el.removeEventListener('keydown', keyboardRippleShow);
    el.removeEventListener('keyup', keyboardRippleHide);
    el.removeEventListener('dragstart', rippleHide);
}
function directive(el, binding, node) {
    updateRipple(el, binding, false);
    if (process.env.NODE_ENV === 'development') {
        // warn if an inline element is used, waiting for el to be in the DOM first
        node.context && node.context.$nextTick(() => {
            const computed = window.getComputedStyle(el);
            if (computed && computed.display === 'inline') {
                const context = node.fnOptions ? [node.fnOptions, node.context] : [node.componentInstance];
                consoleWarn('v-ripple can only be used on block-level elements', ...context);
            }
        });
    }
}
function unbind(el) {
    delete el._ripple;
    removeListeners(el);
}
function update(el, binding) {
    if (binding.value === binding.oldValue) {
        return;
    }
    const wasEnabled = isRippleEnabled(binding.oldValue);
    updateRipple(el, binding, wasEnabled);
}
export const Ripple = {
    bind: directive,
    unbind,
    update,
};
export default Ripple;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvZGlyZWN0aXZlcy9yaXBwbGUvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsU0FBUztBQUNULE9BQU8sZ0JBQWdCLENBQUE7QUFFdkIsWUFBWTtBQUNaLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQTtBQUNoRCxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sb0JBQW9CLENBQUE7QUFPN0MsU0FBUyxTQUFTLENBQUUsRUFBZSxFQUFFLEtBQWE7SUFDaEQsRUFBRSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsR0FBRyxLQUFLLENBQUE7SUFDN0IsRUFBRSxDQUFDLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLEtBQUssQ0FBQTtBQUNyQyxDQUFDO0FBRUQsU0FBUyxPQUFPLENBQUUsRUFBZSxFQUFFLEtBQWE7SUFDOUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsR0FBRyxLQUFLLENBQUMsUUFBUSxFQUFFLENBQUE7QUFDeEMsQ0FBQztBQVFELFNBQVMsWUFBWSxDQUFFLENBQXFCO0lBQzFDLE9BQU8sQ0FBQyxDQUFDLFdBQVcsQ0FBQyxJQUFJLEtBQUssWUFBWSxDQUFBO0FBQzVDLENBQUM7QUFFRCxTQUFTLGVBQWUsQ0FBRSxDQUFxQjtJQUM3QyxPQUFPLENBQUMsQ0FBQyxXQUFXLENBQUMsSUFBSSxLQUFLLGVBQWUsQ0FBQTtBQUMvQyxDQUFDO0FBRUQsTUFBTSxTQUFTLEdBQUcsQ0FDaEIsQ0FBcUIsRUFDckIsRUFBZSxFQUNmLFFBQXVCLEVBQUUsRUFDekIsRUFBRTtJQUNGLElBQUksTUFBTSxHQUFHLENBQUMsQ0FBQTtJQUNkLElBQUksTUFBTSxHQUFHLENBQUMsQ0FBQTtJQUVkLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLEVBQUU7UUFDdkIsTUFBTSxNQUFNLEdBQUcsRUFBRSxDQUFDLHFCQUFxQixF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QUUsT0FBTyxFQUFFLFVBQVUsQ0FBQyxDQUFBO0FBQ3ZDLENBQUM7QUFFRCxNQUFNLENBQUMsTUFBTSxNQUFNLEdBQUc7SUFDcEIsSUFBSSxFQUFFLFNBQVM7SUFDZixNQUFNO0lBQ04sTUFBTTtDQUNQLENBQUE7QUFFRCxlQUFlLE1BQU0sQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8vIFN0eWxlc1xuaW1wb3J0ICcuL1ZSaXBwbGUuc2FzcydcblxuLy8gVXRpbGl0aWVzXG5pbXBvcnQgeyBjb25zb2xlV2FybiB9IGZyb20gJy4uLy4uL3V0aWwvY29uc29sZSdcbmltcG9ydCB7IGtleUNvZGVzIH0gZnJvbSAnLi4vLi4vdXRpbC9oZWxwZXJzJ1xuXG4vLyBUeXBlc1xuaW1wb3J0IHsgVk5vZGUsIFZOb2RlRGlyZWN0aXZlIH0gZnJvbSAndnVlJ1xuXG50eXBlIFZ1ZXRpZnlSaXBwbGVFdmVudCA9IE1vdXNlRXZlbnQgfCBUb3VjaEV2ZW50IHwgS2V5Ym9hcmRFdmVudFxuXG5mdW5jdGlvbiB0cmFuc2Zvcm0gKGVsOiBIVE1MRWxlbWVudCwgdmFsdWU6IHN0cmluZykge1xuICBlbC5zdHlsZVsndHJhbnNmb3JtJ10gPSB2YWx1ZVxuICBlbC5zdHlsZVsnd2Via2l0VHJhbnNmb3JtJ10gPSB2YWx1ZVxufVxuXG5mdW5jdGlvbiBvcGFjaXR5IChlbDogSFRNTEVsZW1lbnQsIHZhbHVlOiBudW1iZXIpIHtcbiAgZWwuc3R5bGVbJ29wYWNpdHknXSA9IHZhbHVlLnRvU3RyaW5nKClcbn1cblxuZXhwb3J0IGludGVyZmFjZSBSaXBwbGVPcHRpb25zIHtcbiAgY2xhc3M/OiBzdHJpbmdcbiAgY2VudGVyPzogYm9vbGVhblxuICBjaXJjbGU/OiBib29sZWFuXG59XG5cbmZ1bmN0aW9uIGlzVG91Y2hFdmVudCAoZTogVnVldGlmeVJpcHBsZUV2ZW50KTogZSBpcyBUb3VjaEV2ZW50IHtcbiAgcmV0dXJuIGUuY29uc3RydWN0b3IubmFtZSA9PT0gJ1RvdWNoRXZlbnQnXG59XG5cbmZ1bmN0aW9uIGlzS2V5Ym9hcmRFdmVudCAoZTogVnVldGlmeVJpcHBsZUV2ZW50KTogZSBpcyBLZXlib2FyZEV2ZW50IHtcbiAgcmV0dXJuIGUuY29uc3RydWN0b3IubmFtZSA9PT0gJ0tleWJvYXJkRXZlbnQnXG59XG5cbmNvbnN0IGNhbGN1bGF0ZSA9IChcbiAgZTogVnVldGlmeVJpcHBsZUV2ZW50LFxuICBlbDogSFRNTEVsZW1lbnQsXG4gIHZhbHVlOiBSaXBwbGVPcHRpb25zID0ge31cbikgPT4ge1xuICBsZXQgbG9jYWxYID0gMFxuICBsZXQgbG9jYWxZID0gMFxuXG4gIGlmICghaXNLZXlib2FyZEV2ZW50KGUpKSB7XG4gICAgY29uc3Qgb2Zmc2V0ID0gZWwuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KClcbiAgICBjb25zdCB0YXJnZXQgPSBpc1RvdWNoRXZlbnQoZSkgPyBlLnRvdWNoZXNbZS50b3VjaGVzLmxlbmd0aCAtIDFdIDogZVxuXG4gICAgbG9jYWxYID0gdGFyZ2V0LmNsaWVudFggLSBvZmZzZXQubGVmdFxuICAgIGxvY2FsWSA9IHRhcmdldC5jbGllbnRZIC0gb2Zmc2V0LnRvcFxuICB9XG5cbiAgbGV0IHJhZGl1cyA9IDBcbiAgbGV0IHNjYWxlID0gMC4zXG4gIGlmIChlbC5fcmlwcGxlICYmIGVsLl9yaXBwbGUuY2lyY2xlKSB7XG4gICAgc2NhbGUgPSAwLjE1XG4gICAgcmFkaXVzID0gZWwuY2xpZW50V2lkdGggLyAyXG4gICAgcmFkaXVzID0gdmFsdWUuY2VudGVyID8gcmFkaXVzIDogcmFkaXVzICsgTWF0aC5zcXJ0KChsb2NhbFggLSByYWRpdXMpICoqIDIgKyAobG9jYWxZIC0gcmFkaXVzKSAqKiAyKSAvIDRcbiAgfSBlbHNlIHtcbiAgICByYWRpdXMgPSBNYXRoLnNxcnQoZWwuY2xpZW50V2lkdGggKiogMiArIGVsLmNsaWVudEhlaWdodCAqKiAyKSAvIDJcbiAgfVxuXG4gIGNvbnN0IGNlbnRlclggPSBgJHsoZWwuY2xpZW50V2lkdGggLSAocmFkaXVzICogMikpIC8gMn1weGBcbiAgY29uc3QgY2VudGVyWSA9IGAkeyhlbC5jbGllbnRIZWlnaHQgLSAocmFkaXVzICogMikpIC8gMn1weGBcblxuICBjb25zdCB4ID0gdmFsdWUuY2VudGVyID8gY2VudGVyWCA6IGAke2xvY2FsWCAtIHJhZGl1c31weGBcbiAgY29uc3QgeSA9IHZhbHVlLmNlbnRlciA/IGNlbnRlclkgOiBgJHtsb2NhbFkgLSByYWRpdXN9cHhgXG5cbiAgcmV0dXJuIHsgcmFkaXVzLCBzY2FsZSwgeCwgeSwgY2VudGVyWCwgY2VudGVyWSB9XG59XG5cbmNvbnN0IHJpcHBsZXMgPSB7XG4gIC8qIGVzbGludC1kaXNhYmxlIG1heC1zdGF0ZW1lbnRzICovXG4gIHNob3cgKFxuICAgIGU6IFZ1ZXRpZnlSaXBwbGVFdmVudCxcbiAgICBlbDogSFRNTEVsZW1lbnQsXG4gICAgdmFsdWU6IFJpcHBsZU9wdGlvbnMgPSB7fVxuICApIHtcbiAgICBpZiAoIWVsLl9yaXBwbGUgfHwgIWVsLl9yaXBwbGUuZW5hYmxlZCkge1xuICAgICAgcmV0dXJuXG4gICAgfVxuXG4gICAgY29uc3QgY29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpXG4gICAgY29uc3QgYW5pbWF0aW9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpXG5cbiAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoYW5pbWF0aW9uKVxuICAgIGNvbnRhaW5lci5jbGFzc05hbWUgPSAndi1yaXBwbGVfX2NvbnRhaW5lcidcblxuICAgIGlmICh2YWx1ZS5jbGFzcykge1xuICAgICAgY29udGFpbmVyLmNsYXNzTmFtZSArPSBgICR7dmFsdWUuY2xhc3N9YFxuICAgIH1cblxuICAgIGNvbnN0IHsgcmFkaXVzLCBzY2FsZSwgeCwgeSwgY2VudGVyWCwgY2VudGVyWSB9ID0gY2FsY3VsYXRlKGUsIGVsLCB2YWx1ZSlcblxuICAgIGNvbnN0IHNpemUgPSBgJHtyYWRpdXMgKiAyfXB4YFxuICAgIGFuaW1hdGlvbi5jbGFzc05hbWUgPSAndi1yaXBwbGVfX2FuaW1hdGlvbidcbiAgICBhbmltYXRpb24uc3R5bGUud2lkdGggPSBzaXplXG4gICAgYW5pbWF0aW9uLnN0eWxlLmhlaWdodCA9IHNpemVcblxuICAgIGVsLmFwcGVuZENoaWxkKGNvbnRhaW5lcilcblxuICAgIGNvbnN0IGNvbXB1dGVkID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoZWwpXG4gICAgaWYgKGNvbXB1dGVkICYmIGNvbXB1dGVkLnBvc2l0aW9uID09PSAnc3RhdGljJykge1xuICAgICAgZWwuc3R5bGUucG9zaXRpb24gPSAncmVsYXRpdmUnXG4gICAgICBlbC5kYXRhc2V0LnByZXZpb3VzUG9zaXRpb24gPSAnc3RhdGljJ1xuICAgIH1cblxuICAgIGFuaW1hdGlvbi5jbGFzc0xpc3QuYWRkKCd2LXJpcHBsZV9fYW5pbWF0aW9uLS1lbnRlcicpXG4gICAgYW5pbWF0aW9uLmNsYXNzTGlzdC5hZGQoJ3YtcmlwcGxlX19hbmltYXRpb24tLXZpc2libGUnKVxuICAgIHRyYW5zZm9ybShhbmltYXRpb24sIGB0cmFuc2xhdGUoJHt4fSwgJHt5fSkgc2NhbGUzZCgke3NjYWxlfSwke3NjYWxlfSwke3NjYWxlfSlgKVxuICAgIG9wYWNpdHkoYW5pbWF0aW9uLCAwKVxuICAgIGFuaW1hdGlvbi5kYXRhc2V0LmFjdGl2YXRlZCA9IFN0cmluZyhwZXJmb3JtYW5jZS5ub3coKSlcblxuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgYW5pbWF0aW9uLmNsYXNzTGlzdC5yZW1vdmUoJ3YtcmlwcGxlX19hbmltYXRpb24tLWVudGVyJylcbiAgICAgIGFuaW1hdGlvbi5jbGFzc0xpc3QuYWRkKCd2LXJpcHBsZV9fYW5pbWF0aW9uLS1pbicpXG4gICAgICB0cmFuc2Zvcm0oYW5pbWF0aW9uLCBgdHJhbnNsYXRlKCR7Y2VudGVyWH0sICR7Y2VudGVyWX0pIHNjYWxlM2QoMSwxLDEpYClcbiAgICAgIG9wYWNpdHkoYW5pbWF0aW9uLCAwLjI1KVxuICAgIH0sIDApXG4gIH0sXG5cbiAgaGlkZSAoZWw6IEhUTUxFbGVtZW50IHwgbnVsbCkge1xuICAgIGlmICghZWwgfHwgIWVsLl9yaXBwbGUgfHwgIWVsLl9yaXBwbGUuZW5hYmxlZCkgcmV0dXJuXG5cbiAgICBjb25zdCByaXBwbGVzID0gZWwuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgndi1yaXBwbGVfX2FuaW1hdGlvbicpXG5cbiAgICBpZiAocmlwcGxlcy5sZW5ndGggPT09IDApIHJldHVyblxuICAgIGNvbnN0IGFuaW1hdGlvbiA9IHJpcHBsZXNbcmlwcGxlcy5sZW5ndGggLSAxXVxuXG4gICAgaWYgKGFuaW1hdGlvbi5kYXRhc2V0LmlzSGlkaW5nKSByZXR1cm5cbiAgICBlbHNlIGFuaW1hdGlvbi5kYXRhc2V0LmlzSGlkaW5nID0gJ3RydWUnXG5cbiAgICBjb25zdCBkaWZmID0gcGVyZm9ybWFuY2Uubm93KCkgLSBOdW1iZXIoYW5pbWF0aW9uLmRhdGFzZXQuYWN0aXZhdGVkKVxuICAgIGNvbnN0IGRlbGF5ID0gTWF0aC5tYXgoMjUwIC0gZGlmZiwgMClcblxuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgYW5pbWF0aW9uLmNsYXNzTGlzdC5yZW1vdmUoJ3YtcmlwcGxlX19hbmltYXRpb24tLWluJylcbiAgICAgIGFuaW1hdGlvbi5jbGFzc0xpc3QuYWRkKCd2LXJpcHBsZV9fYW5pbWF0aW9uLS1vdXQnKVxuICAgICAgb3BhY2l0eShhbmltYXRpb24sIDApXG5cbiAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICBjb25zdCByaXBwbGVzID0gZWwuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgndi1yaXBwbGVfX2FuaW1hdGlvbicpXG4gICAgICAgIGlmIChyaXBwbGVzLmxlbmd0aCA9PT0gMSAmJiBlbC5kYXRhc2V0LnByZXZpb3VzUG9zaXRpb24pIHtcbiAgICAgICAgICBlbC5zdHlsZS5wb3NpdGlvbiA9IGVsLmRhdGFzZXQucHJldmlvdXNQb3NpdGlvblxuICAgICAgICAgIGRlbGV0ZSBlbC5kYXRhc2V0LnByZXZpb3VzUG9zaXRpb25cbiAgICAgICAgfVxuXG4gICAgICAgIGFuaW1hdGlvbi5wYXJlbnROb2RlICYmIGVsLnJlbW92ZUNoaWxkKGFuaW1hdGlvbi5wYXJlbnROb2RlKVxuICAgICAgfSwgMzAwKVxuICAgIH0sIGRlbGF5KVxuICB9LFxufVxuXG5mdW5jdGlvbiBpc1JpcHBsZUVuYWJsZWQgKHZhbHVlOiBhbnkpOiB2YWx1ZSBpcyB0cnVlIHtcbiAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ3VuZGVmaW5lZCcgfHwgISF2YWx1ZVxufVxuXG5mdW5jdGlvbiByaXBwbGVTaG93IChlOiBWdWV0aWZ5UmlwcGxlRXZlbnQpIHtcbiAgY29uc3QgdmFsdWU6IFJpcHBsZU9wdGlvbnMgPSB7fVxuICBjb25zdCBlbGVtZW50ID0gZS5jdXJyZW50VGFyZ2V0IGFzIEhUTUxFbGVtZW50XG4gIGlmICghZWxlbWVudCB8fCAhZWxlbWVudC5fcmlwcGxlIHx8IGVsZW1lbnQuX3JpcHBsZS50b3VjaGVkKSByZXR1cm5cbiAgaWYgKGlzVG91Y2hFdmVudChlKSkge1xuICAgIGVsZW1lbnQuX3JpcHBsZS50b3VjaGVkID0gdHJ1ZVxuICAgIGVsZW1lbnQuX3JpcHBsZS5pc1RvdWNoID0gdHJ1ZVxuICB9IGVsc2Uge1xuICAgIC8vIEl0J3MgcG9zc2libGUgZm9yIHRvdWNoIGV2ZW50cyB0byBmaXJlXG4gICAgLy8gYXMgbW91c2UgZXZlbnRzIG9uIEFuZHJvaWQvaU9TLCB0aGlzXG4gICAgLy8gd2lsbCBza2lwIHRoZSBldmVudCBjYWxsIGlmIGl0IGhhc1xuICAgIC8vIGFscmVhZHkgYmVlbiByZWdpc3RlcmVkIGFzIHRvdWNoXG4gICAgaWYgKGVsZW1lbnQuX3JpcHBsZS5pc1RvdWNoKSByZXR1cm5cbiAgfVxuICB2YWx1ZS5jZW50ZXIgPSBlbGVtZW50Ll9yaXBwbGUuY2VudGVyZWQgfHwgaXNLZXlib2FyZEV2ZW50KGUpXG4gIGlmIChlbGVtZW50Ll9yaXBwbGUuY2xhc3MpIHtcbiAgICB2YWx1ZS5jbGFzcyA9IGVsZW1lbnQuX3JpcHBsZS5jbGFzc1xuICB9XG4gIHJpcHBsZXMuc2hvdyhlLCBlbGVtZW50LCB2YWx1ZSlcbn1cblxuZnVuY3Rpb24gcmlwcGxlSGlkZSAoZTogRXZlbnQpIHtcbiAgY29uc3QgZWxlbWVudCA9IGUuY3VycmVudFRhcmdldCBhcyBIVE1MRWxlbWVudCB8IG51bGxcbiAgaWYgKCFlbGVtZW50KSByZXR1cm5cblxuICB3aW5kb3cuc2V0VGltZW91dCgoKSA9PiB7XG4gICAgaWYgKGVsZW1lbnQuX3JpcHBsZSkge1xuICAgICAgZWxlbWVudC5fcmlwcGxlLnRvdWNoZWQgPSBmYWxzZVxuICAgIH1cbiAgfSlcbiAgcmlwcGxlcy5oaWRlKGVsZW1lbnQpXG59XG5cbmxldCBrZXlib2FyZFJpcHBsZSA9IGZhbHNlXG5mdW5jdGlvbiBrZXlib2FyZFJpcHBsZVNob3cgKGU6IEtleWJvYXJkRXZlbnQpIHtcbiAgaWYgKCFrZXlib2FyZFJpcHBsZSAmJiAoZS5rZXlDb2RlID09PSBrZXlDb2Rlcy5lbnRlciB8fCBlLmtleUNvZGUgPT09IGtleUNvZGVzLnNwYWNlKSkge1xuICAgIGtleWJvYXJkUmlwcGxlID0gdHJ1ZVxuICAgIHJpcHBsZVNob3coZSlcbiAgfVxufVxuZnVuY3Rpb24ga2V5Ym9hcmRSaXBwbGVIaWRlIChlOiBLZXlib2FyZEV2ZW50KSB7XG4gIGtleWJvYXJkUmlwcGxlID0gZmFsc2VcbiAgcmlwcGxlSGlkZShlKVxufVxuXG5mdW5jdGlvbiB1cGRhdGVSaXBwbGUgKGVsOiBIVE1MRWxlbWVudCwgYmluZGluZzogVk5vZGVEaXJlY3RpdmUsIHdhc0VuYWJsZWQ6IGJvb2xlYW4pIHtcbiAgY29uc3QgZW5hYmxlZCA9IGlzUmlwcGxlRW5hYmxlZChiaW5kaW5nLnZhbHVlKVxuICBpZiAoIWVuYWJsZWQpIHtcbiAgICByaXBwbGVzLmhpZGUoZWwpXG4gIH1cbiAgZWwuX3JpcHBsZSA9IGVsLl9yaXBwbGUgfHwge31cbiAgZWwuX3JpcHBsZS5lbmFibGVkID0gZW5hYmxlZFxuICBjb25zdCB2YWx1ZSA9IGJpbmRpbmcudmFsdWUgfHwge31cbiAgaWYgKHZhbHVlLmNlbnRlcikge1xuICAgIGVsLl9yaXBwbGUuY2VudGVyZWQgPSB0cnVlXG4gIH1cbiAgaWYgKHZhbHVlLmNsYXNzKSB7XG4gICAgZWwuX3JpcHBsZS5jbGFzcyA9IGJpbmRpbmcudmFsdWUuY2xhc3NcbiAgfVxuICBpZiAodmFsdWUuY2lyY2xlKSB7XG4gICAgZWwuX3JpcHBsZS5jaXJjbGUgPSB2YWx1ZS5jaXJjbGVcbiAgfVxuICBpZiAoZW5hYmxlZCAmJiAhd2FzRW5hYmxlZCkge1xuICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCByaXBwbGVTaG93LCB7IHBhc3NpdmU6IHRydWUgfSlcbiAgICBlbC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIHJpcHBsZUhpZGUsIHsgcGFzc2l2ZTogdHJ1ZSB9KVxuICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoY2FuY2VsJywgcmlwcGxlSGlkZSlcblxuICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIHJpcHBsZVNob3cpXG4gICAgZWwuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIHJpcHBsZUhpZGUpXG4gICAgZWwuYWRkRXZlbnRMaXN0ZW5lcignbW91c2VsZWF2ZScsIHJpcHBsZUhpZGUpXG5cbiAgICBlbC5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywga2V5Ym9hcmRSaXBwbGVTaG93KVxuICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ2tleXVwJywga2V5Ym9hcmRSaXBwbGVIaWRlKVxuXG4gICAgLy8gQW5jaG9yIHRhZ3MgY2FuIGJlIGRyYWdnZWQsIGNhdXNlcyBvdGhlciBoaWRlcyB0byBmYWlsIC0gIzE1MzdcbiAgICBlbC5hZGRFdmVudExpc3RlbmVyKCdkcmFnc3RhcnQnLCByaXBwbGVIaWRlLCB7IHBhc3NpdmU6IHRydWUgfSlcbiAgfSBlbHNlIGlmICghZW5hYmxlZCAmJiB3YXNFbmFibGVkKSB7XG4gICAgcmVtb3ZlTGlzdGVuZXJzKGVsKVxuICB9XG59XG5cbmZ1bmN0aW9uIHJlbW92ZUxpc3RlbmVycyAoZWw6IEhUTUxFbGVtZW50KSB7XG4gIGVsLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIHJpcHBsZVNob3cpXG4gIGVsLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCByaXBwbGVTaG93KVxuICBlbC5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIHJpcHBsZUhpZGUpXG4gIGVsLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoY2FuY2VsJywgcmlwcGxlSGlkZSlcbiAgZWwucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIHJpcHBsZUhpZGUpXG4gIGVsLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlbGVhdmUnLCByaXBwbGVIaWRlKVxuICBlbC5yZW1vdmVFdmVudExpc3RlbmVyKCdrZXlkb3duJywga2V5Ym9hcmRSaXBwbGVTaG93KVxuICBlbC5yZW1vdmVFdmVudExpc3RlbmVyKCdrZXl1cCcsIGtleWJvYXJkUmlwcGxlSGlkZSlcbiAgZWwucmVtb3ZlRXZlbnRMaXN0ZW5lcignZHJhZ3N0YXJ0JywgcmlwcGxlSGlkZSlcbn1cblxuZnVuY3Rpb24gZGlyZWN0aXZlIChlbDogSFRNTEVsZW1lbnQsIGJpbmRpbmc6IFZOb2RlRGlyZWN0aXZlLCBub2RlOiBWTm9kZSkge1xuICB1cGRhdGVSaXBwbGUoZWwsIGJpbmRpbmcsIGZhbHNlKVxuXG4gIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ2RldmVsb3BtZW50Jykge1xuICAgIC8vIHdhcm4gaWYgYW4gaW5saW5lIGVsZW1lbnQgaXMgdXNlZCwgd2FpdGluZyBmb3IgZWwgdG8gYmUgaW4gdGhlIERPTSBmaXJzdFxuICAgIG5vZGUuY29udGV4dCAmJiBub2RlLmNvbnRleHQuJG5leHRUaWNrKCgpID0+IHtcbiAgICAgIGNvbnN0IGNvbXB1dGVkID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoZWwpXG4gICAgICBpZiAoY29tcHV0ZWQgJiYgY29tcHV0ZWQuZGlzcGxheSA9PT0gJ2lubGluZScpIHtcbiAgICAgICAgY29uc3QgY29udGV4dCA9IChub2RlIGFzIGFueSkuZm5PcHRpb25zID8gWyhub2RlIGFzIGFueSkuZm5PcHRpb25zLCBub2RlLmNvbnRleHRdIDogW25vZGUuY29tcG9uZW50SW5zdGFuY2VdXG4gICAgICAgIGNvbnNvbGVXYXJuKCd2LXJpcHBsZSBjYW4gb25seSBiZSB1c2VkIG9uIGJsb2NrLWxldmVsIGVsZW1lbnRzJywgLi4uY29udGV4dClcbiAgICAgIH1cbiAgICB9KVxuICB9XG59XG5cbmZ1bmN0aW9uIHVuYmluZCAoZWw6IEhUTUxFbGVtZW50KSB7XG4gIGRlbGV0ZSBlbC5fcmlwcGxlXG4gIHJlbW92ZUxpc3RlbmVycyhlbClcbn1cblxuZnVuY3Rpb24gdXBkYXRlIChlbDogSFRNTEVsZW1lbnQsIGJpbmRpbmc6IFZOb2RlRGlyZWN0aXZlKSB7XG4gIGlmIChiaW5kaW5nLnZhbHVlID09PSBiaW5kaW5nLm9sZFZhbHVlKSB7XG4gICAgcmV0dXJuXG4gIH1cblxuICBjb25zdCB3YXNFbmFibGVkID0gaXNSaXBwbGVFbmFibGVkKGJpbmRpbmcub2xkVmFsdWUpXG4gIHVwZGF0ZVJpcHBsZShlbCwgYmluZGluZywgd2FzRW5hYmxlZClcbn1cblxuZXhwb3J0IGNvbnN0IFJpcHBsZSA9IHtcbiAgYmluZDogZGlyZWN0aXZlLFxuICB1bmJpbmQsXG4gIHVwZGF0ZSxcbn1cblxuZXhwb3J0IGRlZmF1bHQgUmlwcGxlXG4iXX0=